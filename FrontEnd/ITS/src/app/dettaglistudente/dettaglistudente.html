<div class="dettagli-container">
  <div class="header-actions">
    <button mat-icon-button (click)="goBack()" matTooltip="Indietro">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1 class="page-title">Dettagli Studente</h1>
  </div>

  <div *ngIf="!loading && studente" class="content-wrapper">
    <!-- Student Info Card -->
    <mat-card class="student-card">
      <mat-card-header>
        <div mat-card-avatar class="student-avatar">
          <mat-icon>person</mat-icon>
        </div>
        <mat-card-title>{{ studente.nome }} {{ studente.cognome }}</mat-card-title>
        <mat-card-subtitle *ngIf="studente.matricola">Matricola: {{ studente.matricola }}</mat-card-subtitle>
        <mat-card-subtitle *ngIf="!studente.matricola">ID: {{ studente._id }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">Email</span>
            <span class="value">{{ studente.email }}</span>
          </div>
          <div class="info-item" *ngIf="studente.corso">
            <span class="label">Corso</span>
            <span class="value">{{ studente.corso }}</span>
          </div>
          <div class="info-item" *ngIf="studente.stato">
            <span class="label">Stato</span>
            <span class="chip" [ngClass]="studente.stato">{{ studente.stato.replace('_', ' ') }}</span>
          </div>
          
          <!-- Moduli Iscritti -->
          <div class="info-item full-width" *ngIf="studente.moduliIscritti && studente.moduliIscritti.length > 0">
            <span class="label">Moduli Iscritti</span>
            <span class="value">{{ studente.moduliIscritti.join(', ') }}</span>
          </div>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button color="primary" (click)="modificaCredenziali()">
          <mat-icon>edit</mat-icon> Modifica Credenziali
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Statistics Section -->
    <div class="statistics-section">
      <div style="display: flex; gap: 16px;">
        <!-- Media Voti Card -->
        <mat-card class="stat-card" style="flex: 1;">
          <mat-card-header>
            <mat-icon mat-card-avatar style="background: #4caf50; color: white; display: flex; align-items: center; justify-content: center;">trending_up</mat-icon>
            <mat-card-title>Media Voti</mat-card-title>
            <mat-card-subtitle>Performance complessiva</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content style="text-align: center; padding: 20px;">
            <div *ngIf="mediaVoti !== null" style="font-size: 48px; font-weight: bold; color: #4caf50;">
              {{ mediaVoti }}
            </div>
            <div *ngIf="mediaVoti === null" style="font-size: 16px; color: #999;">
              Nessun voto disponibile
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Voti Alti Card -->
        <mat-card class="stat-card" style="flex: 1;">
          <mat-card-header>
            <mat-icon mat-card-avatar style="background: #ff9800; color: white; display: flex; align-items: center; justify-content: center;">star</mat-icon>
            <mat-card-title>Voti Alti (≥24)</mat-card-title>
            <mat-card-subtitle>Esami eccellenti</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content style="padding: 20px;">
            <div *ngIf="votiAlti && votiAlti.length > 0" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
              <span *ngFor="let voto of votiAlti" class="voto-badge high-grade">{{ voto }}</span>
            </div>
            <div *ngIf="!votiAlti || votiAlti.length === 0" style="text-align: center; font-size: 16px; color: #999;">
              Nessun voto ≥24
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Exams Section -->
    <div class="exams-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">Esami Sostenuti</h2>
        <button mat-stroked-button color="primary" (click)="gestisciEsami()">
          <mat-icon>edit_note</mat-icon>
          Aggiungi Esami
        </button>
      </div>
      <mat-card class="exams-card">
        <mat-list>
          <ng-container *ngFor="let esame of studente.esami; let last = last">
            <mat-list-item>
              <mat-icon matListItemIcon>school</mat-icon>
              <span matListItemTitle>{{ esame.modulo.nome || 'N/A' }} ({{ esame.modulo.codice || 'N/A' }})</span>
              <span matListItemLine>
                {{ esame.data | date:'dd/MM/yyyy' }}
                <span *ngIf="esame.note"> - {{ esame.note }}</span>
              </span>
              <span class="voto-badge" [class.high-grade]="esame.voto >= 27">
                {{ esame.voto }}/30
              </span>
            </mat-list-item>
            <mat-divider *ngIf="!last"></mat-divider>
          </ng-container>
          <div *ngIf="!studente.esami || studente.esami.length === 0" class="no-exams">
            <p>Nessun esame registrato.</p>
          </div>
        </mat-list>
      </mat-card>
    </div>
  </div>

  <div *ngIf="!loading && !studente" class="error-state">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <p>Studente non trovato.</p>
    <button mat-raised-button color="primary" (click)="goBack()">Torna all'elenco</button>
  </div>
</div>
